# Passbolt Pro Demonstration Stack - Multi-Domain LDAP with LDAPS Security
# Multi-domain LDAP directory synchronization using PHP configuration with LDAPS encryption
# Demonstrates enterprise merger scenario with secure aggregated directory sync
# Use: docker compose up -d

services:
  db:
    image: mariadb:10.11
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "rootpassword"
      MYSQL_DATABASE: "passbolt"
      MYSQL_USER: "passbolt"
      MYSQL_PASSWORD: "P4ssb0lt"
    volumes:
      - database_volume:/var/lib/mysql
      - ./config/db/init-keycloak-db.sql:/docker-entrypoint-initdb.d/init-keycloak-db.sql

  smtp4dev:
    image: rnwood/smtp4dev:v3
    container_name: smtp4dev
    restart: unless-stopped
    ports:
      - '5050:80'    # Web interface
      - '465:25'     # Implicit TLS SMTP
    volumes:
      - ./smtp4dev/certs:/certs:ro
      - smtp4dev_data:/smtp4dev
    environment:
      - ServerOptions__Urls=http://*:80
      - ServerOptions__HostName=smtp.local
      - ServerOptions__TlsMode=ImplicitTls
      - ServerOptions__TlsCertificate=/certs/tls.pfx
      - ServerOptions__TlsCertificatePassword=changeme
    networks:
      default:
        aliases:
          - smtp.local

  keycloak:
    image: quay.io/keycloak/keycloak:26.3.0
    container_name: keycloak
    restart: unless-stopped
    depends_on:
      - db
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME: keycloak.local
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/conf/server.crt.pem
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/conf/server.key.pem
      KC_DB: mariadb
      KC_DB_URL: jdbc:mariadb://db:3306/keycloak
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: rootpassword
    ports:
      - '8081:8080'
      - '8443:8443'
      - '8787:8787'
    volumes:
      - ./keys/keycloak.crt:/opt/keycloak/conf/server.crt.pem:ro
      - ./keys/keycloak.key:/opt/keycloak/conf/server.key.pem:ro
    command: ["start-dev"]
    networks:
      default:
        aliases:
          - keycloak.local

  valkey:
    image: valkey/valkey:9.0-trixie
    container_name: valkey
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    command: valkey-server --appendonly yes

  passbolt:
    image: passbolt/passbolt:latest-pro
    restart: unless-stopped
    depends_on:
      - db
      - keycloak
      - valkey
      - ldap1
      - ldap2
    environment:
      APP_FULL_BASE_URL: https://passbolt.local
      DATASOURCES_DEFAULT_HOST: "db"
      DATASOURCES_DEFAULT_USERNAME: "passbolt"
      DATASOURCES_DEFAULT_PASSWORD: "P4ssb0lt"
      DATASOURCES_DEFAULT_DATABASE: "passbolt"
      
      EMAIL_TRANSPORT_DEFAULT_HOST: "ssl://smtp.local"
      EMAIL_TRANSPORT_DEFAULT_PORT: 25
      EMAIL_TRANSPORT_DEFAULT_USERNAME: ""
      EMAIL_TRANSPORT_DEFAULT_PASSWORD: ""
      EMAIL_DEFAULT_FROM: "admin@passbolt.com"
      
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_VERIFY_PEER: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_VERIFY_PEER_NAME: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_ALLOW_SELF_SIGNED: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_CAFILE: "/etc/ssl/certs/smtp_local.crt"
      
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_ENABLED: "true"
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_ENABLED: "true"
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_VERIFY_PEER: "true"
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_CAFILE: "/etc/ssl/certs/ldaps_bundle.crt"
      
      PASSBOLT_PLUGINS_SSO_ENABLED: "true"
      PASSBOLT_PLUGINS_SSO_PROVIDER_OAUTH2_ENABLED: "true"
      PASSBOLT_SECURITY_SSO_SSL_VERIFY: "true"
      
      PASSBOLT_PLUGINS_JWT_AUTHENTICATION_ENABLED: "true"

      CACHE_CAKECORE_CLASSNAME: Cake\Cache\Engine\RedisEngine
      CACHE_CAKECORE_HOST: valkey
      CACHE_CAKECORE_PORT: 6379
      CACHE_CAKECORE_PASSWORD: ""
      CACHE_CAKECORE_DATABASE: 0
      SESSION_DEFAULTS: cache

    volumes:
      - gpg_volume:/etc/passbolt/gpg
      - jwt_volume:/etc/passbolt/jwt
      - ./config/php/www.conf:/etc/php-fpm.d/www.conf
      - ./config/php/ssl.ini:/etc/php/8.2/cli/conf.d/99-ssl.ini
      - ./config/nginx/nginx-passbolt.conf:/etc/nginx/sites-enabled/nginx-passbolt.conf
      - ./config/passbolt/ldap.php:/etc/passbolt/ldap.php:ro
      - ./keys/ca.crt:/usr/local/share/ca-certificates/keycloak.crt
      - ./keys/passbolt.crt:/etc/ssl/certs/certificate.crt:ro
      - ./keys/passbolt.key:/etc/ssl/certs/certificate.key:ro
      - ./smtp4dev/certs/tls.crt:/etc/ssl/certs/smtp_local.crt:ro
      - ./certs/ldaps_bundle.crt:/etc/ssl/certs/ldaps_bundle.crt:ro
      - ./certs/ldaps_bundle.crt:/usr/local/share/ca-certificates/ldap-ca.crt:ro
      # LDAPS certificate mounts for secure LDAP connections
      - ./keys/ldap1-ca.crt:/etc/ssl/certs/ldap1-ca.crt:ro
      - ./keys/ldap1-ca.crt:/usr/local/share/ca-certificates/ldap1-ca.crt:ro
      - ./keys/ldap2-ca.crt:/etc/ssl/certs/ldap2-ca.crt:ro
      - ./keys/ldap2-ca.crt:/usr/local/share/ca-certificates/ldap2-ca.crt:ro
      - ./subscription_key.txt:/etc/passbolt/subscription_key.txt:ro
    command:
      - /bin/bash
      - -c
      - |
        update-ca-certificates
        chown www-data:www-data /etc/passbolt/jwt
        chmod 755 /etc/passbolt/jwt
        /usr/bin/wait-for.sh -t 0 db:3306 -- /docker-entrypoint.sh
    ports:
      - 80:80
      - 443:443
      - 9000:9000
    networks:
      default:
        aliases:
          - passbolt.local

  # LDAP Server 1 - Passbolt Inc. (Historical Computing Pioneers)
  # Contains: Ada, Betty, Carol, Dame, Edith with @passbolt.com emails
  ldap1:
    image: osixia/openldap:1.5.0
    container_name: ldap1
    hostname: ldap1.local
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "Passbolt"
      LDAP_DOMAIN: "passbolt.local"
      LDAP_ADMIN_PASSWORD: "P4ssb0lt"
      LDAP_CONFIG_PASSWORD: "P4ssb0lt"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "readonly"
      LDAP_READONLY_USER_PASSWORD: "readonly"
      LDAP_TLS: "true"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_BASE_DN: "dc=passbolt,dc=local"
      LDAP_USERS_DN: "ou=users,dc=passbolt,dc=local"
      LDAP_GROUPS_DN: "ou=groups,dc=passbolt,dc=local"
    volumes:
      - ldap1_data:/var/lib/ldap
      - ldap1_config:/etc/ldap/slapd.d
      - ldap1_certs:/container/service/slapd/assets/certs
    networks:
      default:
        aliases:
          - ldap1.local

  # LDAP Server 2 - Example Corp (Modern Tech Professionals)
  # Contains: John, Sarah, Michael, Lisa with @example.com emails
  ldap2:
    image: osixia/openldap:1.5.0
    container_name: ldap2
    hostname: ldap2.local
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "Example Corp"
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: "Ex4mple123"
      LDAP_CONFIG_PASSWORD: "Ex4mple123"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "reader"
      LDAP_READONLY_USER_PASSWORD: "reader123"
      LDAP_TLS: "true"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_BASE_DN: "dc=example,dc=com"
      LDAP_USERS_DN: "ou=people,dc=example,dc=com"
      LDAP_GROUPS_DN: "ou=teams,dc=example,dc=com"
    volumes:
      - ldap2_data:/var/lib/ldap
      - ldap2_config:/etc/ldap/slapd.d
      - ldap2_certs:/container/service/slapd/assets/certs
    networks:
      default:
        aliases:
          - ldap2.local


volumes:
  database_volume:
    name: ${COMPOSE_PROJECT_NAME}_database_volume
  gpg_volume:
    name: ${COMPOSE_PROJECT_NAME}_gpg_volume
  jwt_volume:
    name: ${COMPOSE_PROJECT_NAME}_jwt_volume
  smtp4dev_data:
    name: ${COMPOSE_PROJECT_NAME}_smtp4dev_data
  valkey_data:
    name: ${COMPOSE_PROJECT_NAME}_valkey_data
  ldap1_data:
    name: ${COMPOSE_PROJECT_NAME}_ldap1_data
  ldap1_config:
    name: ${COMPOSE_PROJECT_NAME}_ldap1_config
  ldap1_certs:
    name: ${COMPOSE_PROJECT_NAME}_ldap1_certs
  ldap2_data:
    name: ${COMPOSE_PROJECT_NAME}_ldap2_data
  ldap2_config:
    name: ${COMPOSE_PROJECT_NAME}_ldap2_config
  ldap2_certs:
    name: ${COMPOSE_PROJECT_NAME}_ldap2_certs