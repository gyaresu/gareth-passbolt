# Passbolt Pro Minimal Setup
# Essential services only: Database, Passbolt, Valkey
# Use: docker compose -f docker-compose.minimal.yaml up -d

services:
  db:
    image: mariadb:10.11
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "rootpassword"
      MYSQL_DATABASE: "passbolt"
      MYSQL_USER: "passbolt"
      MYSQL_PASSWORD: "P4ssb0lt"
    volumes:
      - database_volume:/var/lib/mysql

  valkey:
    image: valkey/valkey:9.0-trixie
    container_name: valkey
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    command: valkey-server --appendonly yes

  passbolt:
    image: passbolt/passbolt:latest-pro
    restart: unless-stopped
    depends_on:
      - db
      - valkey
    environment:
      # Core Application Configuration
      APP_FULL_BASE_URL: https://passbolt.local/example
      DATASOURCES_DEFAULT_HOST: "db"
      DATASOURCES_DEFAULT_USERNAME: "passbolt"
      DATASOURCES_DEFAULT_PASSWORD: "P4ssb0lt"
      DATASOURCES_DEFAULT_DATABASE: "passbolt"
      
      # Email Configuration (basic - no SMTP server)
      EMAIL_DEFAULT_FROM: "admin@passbolt.com"
      
      # Valkey sessions
      CACHE_CAKECORE_CLASSNAME: Cake\Cache\Engine\RedisEngine
      CACHE_CAKECORE_HOST: valkey
      CACHE_CAKECORE_PORT: 6379
      CACHE_CAKECORE_PASSWORD: ""
      CACHE_CAKECORE_DATABASE: 0
      SESSION_DEFAULTS: cache

      # SSL Configuration
      PASSBOLT_SSL_FORCE: "true"

    volumes:
      - gpg_volume:/etc/passbolt/gpg
      - jwt_volume:/etc/passbolt/jwt
      - ./config/php/www.conf:/etc/php-fpm.d/www.conf
      - ./config/php/ssl.ini:/etc/php/8.2/cli/conf.d/99-ssl.ini
      - ./config/nginx/nginx-passbolt.conf:/etc/nginx/sites-enabled/nginx-passbolt.conf
      - ./keys/passbolt.crt:/etc/ssl/certs/certificate.crt:ro
      - ./keys/passbolt.key:/etc/ssl/certs/certificate.key:ro
      - ./subscription_key.txt:/etc/passbolt/subscription_key.txt:ro
    command:
      - /bin/bash
      - -c
      - |
        update-ca-certificates
        chown www-data:www-data /etc/passbolt/jwt
        chmod 755 /etc/passbolt/jwt
        /usr/bin/wait-for.sh -t 0 db:3306 -- /docker-entrypoint.sh
    ports:
      - 80:80
      - 443:443
      - 9000:9000
    networks:
      default:
        aliases:
          - passbolt.local

volumes:
  database_volume:
    name: ${COMPOSE_PROJECT_NAME}_database_volume
  gpg_volume:
    name: ${COMPOSE_PROJECT_NAME}_gpg_volume
  jwt_volume:
    name: ${COMPOSE_PROJECT_NAME}_jwt_volume
  valkey_data:
    name: ${COMPOSE_PROJECT_NAME}_valkey_data
