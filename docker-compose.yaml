services:
  db:
    image: mariadb:10.11
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "rootpassword"
      MYSQL_DATABASE: "passbolt"
      MYSQL_USER: "passbolt"
      MYSQL_PASSWORD: "P4ssb0lt"
    volumes:
      - database_volume:/var/lib/mysql
      - ./config/db/init-keycloak-db.sql:/docker-entrypoint-initdb.d/init-keycloak-db.sql

  smtp4dev:
    image: rnwood/smtp4dev:v3
    container_name: smtp4dev
    restart: unless-stopped
    ports:
      - '5050:80'    # Web interface
      - '465:25'     # Implicit TLS SMTP
    volumes:
      - ./smtp4dev/certs:/certs:ro
      - smtp4dev_data:/smtp4dev
    environment:
      - ServerOptions__Urls=http://*:80
      - ServerOptions__HostName=smtp.local
      - ServerOptions__TlsMode=ImplicitTls
      - ServerOptions__TlsCertificate=/certs/tls.pfx
      - ServerOptions__TlsCertificatePassword=changeme
    networks:
      default:
        aliases:
          - smtp.local

  keycloak:
    image: quay.io/keycloak/keycloak:26.3.0
    container_name: keycloak
    restart: unless-stopped
    depends_on:
      - db
    environment:
      # Development credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      # Development settings
      KC_HOSTNAME: keycloak.local
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTPS_CERTIFICATE_FILE: /opt/keycloak/conf/server.crt.pem
      KC_HTTPS_CERTIFICATE_KEY_FILE: /opt/keycloak/conf/server.key.pem
      # Database configuration
      KC_DB: mariadb
      KC_DB_URL_HOST: db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: passbolt
      KC_DB_PASSWORD: P4ssb0lt
    command: 
      - start-dev
    ports:
      - 8081:8080
      - 8787:8787
      - 8443:8443
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./keys/keycloak-chain.crt:/opt/keycloak/conf/server.crt.pem
      - ./keys/keycloak.key:/opt/keycloak/conf/server.key.pem
    networks:
      default:
        aliases:
          - keycloak.local

  passbolt:
    build:
      context: .
      dockerfile: Dockerfile.passbolt
    image: passbolt/passbolt:latest-pro
    restart: unless-stopped
    depends_on:
      - db
      - keycloak
      - valkey
    environment:
      # Core Application Configuration
      APP_FULL_BASE_URL: https://passbolt.local
      DATASOURCES_DEFAULT_HOST: "db"
      DATASOURCES_DEFAULT_USERNAME: "passbolt"
      DATASOURCES_DEFAULT_PASSWORD: "P4ssb0lt"
      DATASOURCES_DEFAULT_DATABASE: "passbolt"
      
      # Email Configuration
      EMAIL_TRANSPORT_DEFAULT_HOST: "ssl://smtp.local"
      EMAIL_TRANSPORT_DEFAULT_PORT: 25
      EMAIL_TRANSPORT_DEFAULT_USERNAME: ""
      EMAIL_TRANSPORT_DEFAULT_PASSWORD: ""
      EMAIL_DEFAULT_FROM: "admin@passbolt.com"
      
      # SMTP Settings Plugin (SMTPS - implicit TLS, SSL verification settings)
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_VERIFY_PEER: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_VERIFY_PEER_NAME: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_ALLOW_SELF_SIGNED: true
      PASSBOLT_PLUGINS_SMTP_SETTINGS_SECURITY_SSL_CAFILE: "/etc/ssl/certs/smtp_local.crt"
      
      # Directory Sync Plugin (LDAPS and LDAP with STARTTLS both enabled)
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_ENABLED: "true" # Note: not functional. Hard coded 'false', see task PB-45139 for task)
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_ENABLED: "true"
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_VERIFY_PEER: "true"
      PASSBOLT_PLUGINS_DIRECTORY_SYNC_SECURITY_SSL_CUSTOM_OPTIONS_CAFILE: "/etc/ssl/certs/ldaps_bundle.crt"
      
      # SSO Plugin
      PASSBOLT_PLUGINS_SSO_ENABLED: "true"
      PASSBOLT_PLUGINS_SSO_PROVIDER_OAUTH2_ENABLED: "true"
      PASSBOLT_SECURITY_SSO_SSL_VERIFY: "true"

      # Valkey sessions
      CACHE_CAKECORE_CLASSNAME: Cake\Cache\Engine\RedisEngine
      CACHE_CAKECORE_HOST: valkey
      CACHE_CAKECORE_PORT: 6379
      CACHE_CAKECORE_PASSWORD: ""
      CACHE_CAKECORE_DATABASE: 0
      SESSION_DEFAULTS: cache

    volumes:
      - gpg_volume:/etc/passbolt/gpg
      - jwt_volume:/etc/passbolt/jwt
      - ./config/php/www.conf:/etc/php-fpm.d/www.conf
      - ./config/php/ssl.ini:/etc/php/8.2/cli/conf.d/99-ssl.ini
      - ./config/nginx/nginx-passbolt.conf:/etc/nginx/sites-enabled/nginx-passbolt.conf
      - ./keys/ca.crt:/usr/local/share/ca-certificates/keycloak.crt
      - ./smtp4dev/certs/tls.crt:/etc/ssl/certs/smtp_local.crt:ro
      - ./certs/ldaps_bundle.crt:/etc/ssl/certs/ldaps_bundle.crt:ro
      - ./certs/ldaps_bundle.crt:/usr/local/share/ca-certificates/ldap-ca.crt:ro # added after image updates
      - ./subscription_key.txt:/etc/passbolt/subscription_key.txt:ro
    command:
      - /bin/bash
      - -c
      - |
        update-ca-certificates
        /usr/bin/wait-for.sh -t 0 db:3306 -- /docker-entrypoint.sh
    ports:
      - 80:80
      - 443:443
      - 9000:9000
    networks:
      default:
        aliases:
          - passbolt.local

  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    hostname: ldap.local
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "Passbolt"
      LDAP_DOMAIN: "passbolt.local"
      LDAP_ADMIN_PASSWORD: "P4ssb0lt"
      LDAP_CONFIG_PASSWORD: "P4ssb0lt"
      LDAP_READONLY_USER: "true"
      LDAP_READONLY_USER_USERNAME: "readonly"
      LDAP_READONLY_USER_PASSWORD: "readonly"
      LDAP_TLS: "true"
      LDAP_TLS_VERIFY_CLIENT: "never"

      # Initial data setup
      LDAP_BASE_DN: "dc=passbolt,dc=local"
      LDAP_USERS_DN: "ou=users,dc=passbolt,dc=local"
      LDAP_GROUPS_DN: "ou=groups,dc=passbolt,dc=local"
      LDAP_ADMIN_USER: "ada"
      LDAP_ADMIN_EMAIL: "ada@passbolt.com"
      LDAP_ADMIN_FIRSTNAME: "Ada"
      LDAP_ADMIN_LASTNAME: "Ada"
      LDAP_ADMIN_UID: "ada"
      LDAP_ADMIN_GIVEN_NAME: "Ada"
      LDAP_ADMIN_SN: "Ada"
      LDAP_ADMIN_CN: "ada"
      LDAP_ADMIN_DN: "cn=ada,ou=users,dc=passbolt,dc=local"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ldap_certs:/container/service/slapd/assets/certs
    networks:
      default:
        aliases:
          - ldap.local
  valkey:
    image: valkey/valkey:9.0-trixie
    container_name: valkey
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - valkey_data:/data
    command: valkey-server --appendonly yes
    

volumes:
  database_volume:
    name: ${COMPOSE_PROJECT_NAME}_database_volume
  gpg_volume:
    name: ${COMPOSE_PROJECT_NAME}_gpg_volume
  jwt_volume:
    name: ${COMPOSE_PROJECT_NAME}_jwt_volume
  keycloak_data:
    name: ${COMPOSE_PROJECT_NAME}_keycloak_data
  smtp4dev_data:
    name: ${COMPOSE_PROJECT_NAME}_smtp4dev_data
  ldap_data:
    name: ${COMPOSE_PROJECT_NAME}_ldap_data
  ldap_config:
    name: ${COMPOSE_PROJECT_NAME}_ldap_config
  ldap_certs:
    name: ${COMPOSE_PROJECT_NAME}_ldap_certs
  valkey_data:
    name: ${COMPOSE_PROJECT_NAME}_valkey_data
