# OpenLDAP Meta Backend Configuration
# Based on proven MaRuifeng/openLDAP-proxy implementation
# Aggregates multiple LDAP backends into unified namespace

# Include schemas
include /etc/ldap/schema/core.schema
include /etc/ldap/schema/cosine.schema
include /etc/ldap/schema/inetorgperson.schema

# Allow LDAPv2 client connections
allow bind_v2

pidfile /var/run/slapd/slapd.pid
argsfile /var/run/slapd/slapd.args

# Load dynamic backend modules
modulepath /usr/lib/ldap
moduleload back_ldap
moduleload back_meta

# TLS Configuration
TLSCACertificateFile /root/openldap_proxy/data/certs/ldap.crt
TLSCertificateFile /root/openldap_proxy/data/certs/ldap.crt
TLSCertificateKeyFile /root/openldap_proxy/data/certs/ldap.key

# Log level
loglevel stats

#######################################################################
# Meta Database for LDAP Aggregation
#######################################################################

database meta
suffix "dc=unified,dc=local"
rootdn "cn=admin,dc=unified,dc=local"
rootpw "secret"

# Backend 1: Passbolt LDAP (ldap1.local:389)
uri "ldap://ldap1.local:389/dc=passbolt,dc=unified,dc=local"
readonly yes
lastmod off
suffixmassage "dc=passbolt,dc=unified,dc=local" "dc=passbolt,dc=local"
rebind-as-user no
idassert-bind bindmethod=simple
   binddn="cn=readonly,dc=passbolt,dc=local"
   credentials="readonly"
   mode=none
   flags=non-prescriptive
idassert-authzFrom "dn.exact:cn=admin,dc=unified,dc=local"

# Backend 2: Company LDAP (ldap2.local:389)
uri "ldap://ldap2.local:389/dc=company,dc=unified,dc=local"
readonly yes
lastmod off
suffixmassage "dc=company,dc=unified,dc=local" "dc=company,dc=org"
rebind-as-user no
idassert-bind bindmethod=simple
   binddn="cn=reader,dc=company,dc=org"
   credentials="reader123"
   mode=none
   flags=non-prescriptive
idassert-authzFrom "dn.exact:cn=admin,dc=unified,dc=local"

# Access control
access to * by * read