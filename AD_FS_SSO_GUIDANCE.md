# AD FS SSO Setup Guidance for Passbolt

## Overview

Passbolt supports AD FS SSO through two approaches:
1. **Dedicated AD FS Provider** (recommended) - Built specifically for AD FS with UPN email claim support
2. **Generic OAuth2 Provider** - Can be used if you need custom email claim mapping

## Key Differences: Keycloak vs AD FS

### Configuration Differences

| Aspect | Keycloak | AD FS |
|--------|----------|-------|
| **Provider Type** | Generic OAuth2 | Dedicated AD FS Provider |
| **Well-known Endpoint** | `/.well-known/openid-configuration` | `/adfs/.well-known/openid-configuration` |
| **Email Claim** | `email` (default) | `upn` (User Principal Name) |
| **Email Claim Override** | Via `PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS` | Not applicable (hardcoded to `upn`) |
| **Login URL Format** | `https://keycloak.domain.com/realms/realm-name` | `https://adfs.domain.com/adfs` |

### AD FS Specific Requirements

1. **Email Claim**: AD FS provider **only** supports `upn` (User Principal Name) as the email claim
   - The UPN must be in email format (e.g., `user@domain.com`)
   - If your AD FS doesn't emit UPN in the token, you'll need to use the generic OAuth2 provider

2. **Well-known Endpoint**: AD FS uses `/adfs/.well-known/openid-configuration`
   - Full URL: `https://adfs.domain.com/adfs/.well-known/openid-configuration`

3. **Redirect URI**: Must be `https://your-passbolt-domain.com/sso/adfs/redirect`

## Setup Options

### Option 1: Test Environment with AD FS (Recommended for Documentation)

#### Using Windows Server with AD FS

1. **Prerequisites**:
   - Windows Server 2016+ with AD FS role installed
   - Domain controller configured
   - SSL certificate for AD FS

2. **AD FS Configuration**:
   ```
   Application Group Type: Server application
   Client ID: [Generated by AD FS]
   Redirect URI: https://passbolt.local/sso/adfs/redirect
   Client Secret: [Generated by AD FS]
   ```

3. **Passbolt Configuration**:
   - Enable AD FS provider: `PASSBOLT_PLUGINS_SSO_PROVIDER_ADFS_ENABLED=true`
   - Configure via Web UI: Administration → Authentication → SSO → AD FS
   - Login URL: `https://adfs.domain.com/adfs`
   - Client ID: [From AD FS]
   - Client Secret: [From AD FS]
   - Email Claim: `upn` (default, cannot be changed)

#### Using Docker AD FS Simulator (Alternative)

For testing without a full Windows Server setup, you can use a Keycloak instance configured to simulate AD FS behavior:

1. **Configure Keycloak to emit UPN claim**:
   - Create a custom mapper in Keycloak
   - Map user attribute to `upn` claim
   - Ensure UPN is in email format

2. **Use generic OAuth2 provider** with `PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS=upn`

### Option 2: Use Generic OAuth2 Provider (If AD FS Provider Doesn't Work)

If your AD FS setup doesn't emit UPN or you need a different email claim:

1. **Enable Generic OAuth2 Provider**:
   ```bash
   PASSBOLT_PLUGINS_SSO_ENABLED=true
   PASSBOLT_PLUGINS_SSO_PROVIDER_OAUTH2_ENABLED=true
   ```

2. **Set Email Claim Alias** (if not using standard `email` claim):
   ```bash
   PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS=upn
   # Or other claim names like:
   # PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS=mail
   # PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS=http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress
   ```

3. **Configure via Web UI**:
   - Administration → Authentication → SSO → OAuth2
   - Issuer URL: `https://adfs.domain.com/adfs`
   - OpenID Configuration Path: `/.well-known/openid-configuration`
   - Client ID: [From AD FS]
   - Client Secret: [From AD FS]
   - Scopes: `openid profile email` (or custom scopes required by AD FS)

## Customer Documentation Template

### Prerequisites

- Passbolt Pro with SSO plugin enabled
- AD FS 2016 or later
- SSL certificate for AD FS
- User Principal Names (UPN) configured in Active Directory in email format

### Step 1: Configure AD FS Application

1. Open **AD FS Management Console**
2. Navigate to **Application Groups** → **Add Application Group**
3. Select **Server application** template
4. Configure:
   - **Name**: Passbolt SSO
   - **Client Identifier**: Note this value (you'll need it for Passbolt)
   - **Redirect URI**: `https://your-passbolt-domain.com/sso/adfs/redirect`
5. On **Configure Application Credentials**:
   - Select **Generate a shared secret**
   - **Copy the secret** (you'll need it for Passbolt)
6. Complete the wizard

### Step 2: Verify AD FS Well-known Endpoint

Test the OpenID Connect discovery endpoint:

```bash
curl https://adfs.yourdomain.com/adfs/.well-known/openid-configuration
```

Expected response includes:
- `issuer`
- `authorization_endpoint`
- `token_endpoint`
- `userinfo_endpoint`

### Step 3: Configure Passbolt

1. **Enable AD FS Provider** (environment variable):
   ```bash
   PASSBOLT_PLUGINS_SSO_ENABLED=true
   PASSBOLT_PLUGINS_SSO_PROVIDER_ADFS_ENABLED=true
   ```

2. **Configure via Web UI**:
   - Log in as administrator
   - Navigate to **Administration** → **Authentication** → **SSO**
   - Select **AD FS** tab
   - Enter:
     - **Login URL**: `https://adfs.yourdomain.com/adfs`
     - **Client ID**: [From AD FS step 1]
     - **Client Secret**: [From AD FS step 1]
     - **Email Claim**: `upn` (default, cannot be changed)
   - Click **Test Connection**
   - If successful, click **Save Settings**

### Step 4: Verify User Email Matching

**Critical**: Ensure user email addresses in Passbolt match the UPN values from AD FS.

- AD FS UPN format: `user@domain.com`
- Passbolt user email: Must match exactly

### Step 5: Test SSO Login

1. Log out of Passbolt
2. On login page, click **Sign in with AD FS**
3. You should be redirected to AD FS login
4. Enter AD FS credentials
5. You should be redirected back to Passbolt and logged in

## Troubleshooting

### Issue: "Email claim not found" or "User not found"

**Cause**: UPN in AD FS token doesn't match email in Passbolt

**Solution**:
1. Verify UPN format in AD FS token (should be email format)
2. Ensure user exists in Passbolt with matching email
3. Check AD FS claim rules to ensure UPN is included in token

### Issue: "Invalid redirect URI"

**Cause**: Redirect URI in AD FS doesn't match Passbolt callback URL

**Solution**:
- AD FS Redirect URI must be exactly: `https://your-passbolt-domain.com/sso/adfs/redirect`
- Check for trailing slashes or protocol mismatches

### Issue: "Well-known endpoint not found"

**Cause**: Incorrect Login URL or OpenID configuration path

**Solution**:
- Verify AD FS Login URL: `https://adfs.domain.com/adfs`
- Test well-known endpoint manually: `https://adfs.domain.com/adfs/.well-known/openid-configuration`
- Ensure AD FS OIDC is enabled

### Issue: Need different email claim (not UPN)

**Solution**: Use generic OAuth2 provider instead:
1. Disable AD FS provider
2. Enable OAuth2 provider
3. Set `PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS` to your claim name
4. Configure via OAuth2 tab in Passbolt UI

## Environment Variables Reference

### AD FS Provider
```bash
PASSBOLT_PLUGINS_SSO_ENABLED=true
PASSBOLT_PLUGINS_SSO_PROVIDER_ADFS_ENABLED=true
PASSBOLT_SECURITY_SSO_SSL_VERIFY=true  # Set to false for self-signed certificates
```

### Generic OAuth2 Provider (Alternative)
```bash
PASSBOLT_PLUGINS_SSO_ENABLED=true
PASSBOLT_PLUGINS_SSO_PROVIDER_OAUTH2_ENABLED=true
PASSBOLT_PLUGINS_SSO_SECURITY_OAUTH2_EMAIL_CLAIM_ALIAS=upn  # or your claim name
PASSBOLT_SECURITY_SSO_SSL_VERIFY=true
```

## Testing Checklist

- [ ] AD FS well-known endpoint accessible
- [ ] AD FS application group created with correct redirect URI
- [ ] Client ID and secret copied from AD FS
- [ ] Passbolt AD FS provider enabled
- [ ] Passbolt configured with AD FS details
- [ ] Test connection successful in Passbolt UI
- [ ] User UPN matches email in Passbolt
- [ ] SSO login flow works end-to-end
- [ ] User can access Passbolt after SSO login

## Additional Resources

- Passbolt SSO Documentation: [Link to official docs]
- AD FS OIDC Configuration: [Microsoft documentation]
- Passbolt API SSO Plugin: `plugins/PassboltEe/Sso/`

